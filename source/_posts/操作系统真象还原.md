---
title: 《操作系统真象还原》笔记
tags: 笔记
---

参考《操作系统真相还原》，持续更新中。。。

<!--more -->

## 1. 基础知识
* CPU通过IO接口(串行，并行)与硬件进行设备传输，但某些外设（显存）可以直接映射到一定范围的地址空间中。
* CPU只知道去**cs:ip**寄存器中指向的内存取指令并执行，当前进程发生中断执行内核代码（内核态，管态）指用户进程陷入内核态（特权0级）。
* 编译器中提前设置好了系统调用的子功能号，系统调用时会直接执行（也可通过标准库执行）。
* CPU采用“段基址+段内偏移地址”来访问任意内存。只要和为物理地址。20位内存地址->将段基址乘以16，左移4位。段寄存器：cs,ds,es等。
* 重定位：程序中地址修改，内容相同。
* 代码段和数据段：指令由操作码和操作数组成。数据和代码时分开的：1. 数据可写，代码只读（编译器分程序段和数据段，操作系统为全局描述附表（GDT）设置属性，CPU确定段基址并执行）；2. CPU缓存命中率提高，3. 节约内存。
* 在保护模式下，段基址为*选择子*，是GDT中对应的段描述符的索引。在分页功能下，虚拟地址要经过CPU页部件转换成物理地址。(实模式和保护模式)
    * 实模式：在程序中用到的地址都是真实的物理地址。程序可以随意修改任意物理地址，有安全问题。
    * 保护模式：分为纯段模式和段页模式。引入了全局描述符表->段描述符，间接访问，特权检查。
* 段的大小由段内偏移地址寻址范围决定的。平坦模式指只有一个段。
* CPU段寄存器：
    * CS 代码段寄存器，代码段基值
    * DS 数据段寄存器，数据段基值
    * SS 堆栈段寄存器，堆栈段基值
    * ES, FS, GS
* Linux的API称为系统调用，通过int0x80软中断实现。Windows的API存放在动态链接库中（DLL）。
* 函数参数放在栈区，1，局部性。2，动态分配内存，节约内容。
* 解释型语言（脚本语言），通过脚本解释器进行分析，动态根据关键字和语法来做出相应的行为。
* 内存以字节为读写单位。
    * 小端字节序：低字节放低地址处。（强制类型转换时不用调整字节序）
    * 大端字节序：低字节放高地址处。（符号容易取出）
* BIOS建立的中断调用（访问硬件）时建立在中断向量表中，通过软中断指令**int 中断号**来调用。（访问外设的两种方式）
    * 内存映射：通过地址总线将外设内存映射到某个区域。
    * 端口操作：通过in/out指令读写端口访问硬件的内存。
* linux系统调用：Linux内核进入保护模式，（中断向量表->中断描述符表）
* C语言
    * 预处理：将高级语言中的宏展开，去注释等。
    * 编译：词法分析、语法分析、语义分析、优化，生成汇编代码。
    * 汇编：将汇编代码编译成机器指令。涉及的概念是节（section），把所有可读写的节和只读可执行的节分别归并到一块。
    * 链接：将目标文件连接成可执行文件。链接器将同属性的节合并成段(segment)
* 开机之后的故事
    * 运行基本输入输出系统BIOS，完成一些简单的检测或初始化工作。
    * 运行主引导记录MBR(Main Boot Record)，为与0盘0道1扇区，内容包含引导程序及参数，分区表，结束标记55和aa
    * 从64字节大小的分区表中选择次引导程序并转交系统控制权，也就是操作系统加载器（内核加载器）。（活动分区用0x80表示存在引导程序）
    * 内核加载器在各分区最开始的扇区，称为操作系统引导记录OBR。（引导扇区）
	
* 内存管理
	* 段基址+段内偏移 进行改进 => 将不常用的段移除内存。 CPU厂商提供了内存段描述符支持，分为全局描述符表和局部描述符表。
	可用来访问限制。
	* 描述符表中有一项指示了某一段是否在内存中，由CPU载入后置1，OS移除清零，通过统计时间段内1的总数就可以计算出使用频率。
	* 为了解除线性地址与物理地址的一一对应关系，引入了分页机制。也就是将段基址：段内偏移所获得的地址作为虚拟地址。
	对于32位的地址，利用前20位作为页表的索引，后12位为页表项中的真实物理地址对应的页内偏移地址。（由页部件实现）
	* 由于一级页表要占用2^20位(1M*BYTE)的内存，太浪费了，因此引入两级页表，在两级页表中，虚拟地址的高10位表示的是页表在页目录表中的索引。
	中10位表示的是物理页在页表中的位置，低12位就是在物理页中的偏移地址。
	* **需要注意**的是，所有页表占的内存是4字节(32位，前20位存地址，后12位记录状态)，因此在索引具体的页表项是，要将虚拟地址乘以4再加上基址。
	* 页目录表的基址存放在CPU的寄存器cr3中，是否开启分页功能存放再cr0寄存器的PG位。